mage_xp_per_perk = 15
mage_level_legacy_4 = 1
mana_drain_large = 30
mana_drain_average = 15
mana_drain_small = 10
mana_drain_disease = 150
mana_gen_legacy_2 = 10
mana_gen_lifestyle = 100
mana_gen_per_magic_circle = 30
mana_gen_per_perk = 2
mana_gen_per_potency = 10
max_mana_legacy_3 = 100
max_mana_per_perk = 30
max_mana_per_potency = 100

# No-brainer value in a magic mod.
# Uses - Is a character even possibly a mage? 'mage_potency > 0' Is the character not a mage? 'mage_potency < 1' How much potential does this mage have? 'mage_potency >= x'
mage_potency = {
	value = 0
	if = { limit = { has_trait = magic_potential_1 } value = 1 } 
	else_if = { limit = { has_trait = magic_potential_2 } value = 2 } 
	else_if = { limit = { has_trait = magic_potential_3 } value = 3 }
}

# No-brainer value in a magic mod.
# Uses - Is a character even possibly educated? 'mage_education > 0' Is the character not educated? 'mage_education < 1' How much education does this mage have? 'mage_education >= x'
mage_education = { # UNCOMMENT WHEN SYSTEM IN PLACE!!!
	value = 0
	if = { limit = { has_trait = education_arcane_1 } value = 1 } 
	else_if = { limit = { has_trait = education_arcane_2 } value = 2 } 
	else_if = { limit = { has_trait = education_arcane_3 } value = 3 }
	else_if = { limit = { has_trait = education_arcane_4 } value = 4 }
}

mage_level_divider = {
	value = 12
	subtract = mage_potency
	subtract = mage_education
	multiply = mage_xp_per_perk
}

mage_xp = {
	value = num_mage_perks
	multiply = mage_xp_per_perk
}

mage_level_base = {
	value = mage_xp
	divide = mage_level_divider
	add = 1
	floor = yes
}

mage_level = {
	value = mage_level_base
	if = {
		limit = { dynasty = { has_dynasty_perk = arcane_legacy_4 } }
		add = mage_level_legacy_4
	}
}

mage_xp_to_next_level = {
	value = mage_level_base
	multiply = mage_level_divider
}

magic_circles_owned_by_character = {
	value = 0
	every_directly_owned_province = {
		if = {
			limit = { has_building = ancient_magic_mana_circle_01 }
			add = 1
		}
		if = {
			limit = { has_building = ancient_magic_mana_circle_02 }
			add = 2
		}
		if = {
			limit = { has_building = ancient_magic_mana_circle_03 }
			add = 3
		}
	}
}

ancient_magic_mana_gen = {
	value = 0
	add = ancient_magic_mana_gen_gen_only
	add = ancient_magic_mana_gen_drain_only
}

ancient_magic_mana_gen_gen_only = {
	value = 0
	add = ancient_magic_mana_gen_perks
	add = ancient_magic_mana_gen_potency
	add = ancient_magic_mana_gen_circles
	add = ancient_magic_mana_gen_lifestyle
	if = {
		limit = {
			exists = dynasty
			dynasty = { has_dynasty_perk = arcane_legacy_2 }
		}
		add = mana_gen_legacy_2
	}
}

ancient_magic_mana_gen_perks = {
	value = num_mage_perks
	multiply = mana_gen_per_perk
}

ancient_magic_mana_gen_potency = {
	value = mage_potency
	multiply = mana_gen_per_potency
}

ancient_magic_mana_gen_circles = {
	value = magic_circles_owned_by_character
	multiply = mana_gen_per_magic_circle
}

ancient_magic_mana_gen_lifestyle = {
	value = 0
	if = {
		limit = { has_focus = magic_mana_focus }
		add = mana_gen_lifestyle
	}
}

ancient_magic_mana_gen_drain_only = {
	add = ancient_magic_mana_drain_auras
	add = ancient_magic_mana_drain_lifestyle
	add = ancient_magic_mana_drain_disease
}

ancient_magic_mana_drain_auras = {
	value = 0
	subtract = {
		value = num_large_auras
		multiply = mana_drain_large
	}
	subtract = {
		value = num_average_auras
		multiply = mana_drain_average
	}
	subtract = {
		value = num_small_auras
		multiply = mana_drain_small
	}
}

ancient_magic_mana_drain_lifestyle = {
	value = 0
	if = {
		limit = { has_focus = magic_arcana_focus }
		subtract = mana_gen_lifestyle
	}
}

ancient_magic_mana_drain_disease = {
	value = 0
	if = {
		limit = { has_trait = mana_devouring }
		add = mana_drain_disease
	}
}

num_large_auras = {
	value = 0
	if = {
		limit = { has_character_modifier = temporal_manipulation_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = elemental_warrior_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = aura_of_death_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = enchanting_aura_modifier }
		add = 1
	}
	if = {
		limit = { has_variable_list = immortals_list }
		every_in_list = {
			variable = immortals_list
			limit = { exists = this has_trait = immortal }
			add = 1
		}
	}
}

num_average_auras = {
	value = 0
	if = {
		limit = { has_character_modifier = magic_haste_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = glimpse_the_future_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = financial_times_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = celerity_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = mass_celerity_modifier }
		add = 1
	}
	if = {
		limit = {
			has_variable = slowness_target
			exists = var:slowness_target
			var:slowness_target = { has_character_modifier = slowness_modifier }
		}
		add = 1
	}
	if = {
		limit = {
			has_variable = mass_slowness_target
			exists = var:mass_slowness_target
			var:mass_slowness_target = { has_character_modifier = mass_slowness_modifier }
		}
		add = 1
	}
	if = {
		limit = { has_character_modifier = flame_aura_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = flaming_weapons_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = living_earthworks_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = control_water_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = drought_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = beguiling_aura_modifier }
		add = 1
	}
}

num_small_auras = {
	value = 0
	if = {
		limit = { has_character_modifier = biomantic_fertility_modifier }
		add = 1
	}
	if = {
		limit = { has_character_modifier = biomantic_infertility_modifier }
		add = 1
	}
}

ancient_magic_max_mana = {
	value = num_mage_perks
	multiply = max_mana_per_perk
	add = {
		value = mage_potency
		multiply = max_mana_per_potency
	}
	if = {
		limit = {
			exists = dynasty
			dynasty = { has_dynasty_perk = arcane_legacy_3 }
		}
		add = max_mana_legacy_3
	}
}

# Note: This value is a work-around for 'consume life' not giving the 'drained' modifier
# 	    for the correct number of years. Removing it will break that spell!
############################################################################################
spell_caster_mage_level = {
	value = scope:spell_caster.mage_level
}

# Note: This value is a work-around for perks firing 'change_mage_perks'
# 	    more times than they should. Removing it will break everything!
############################################################################################
num_mage_perks = {
	value = 0
	# Time tree
	if = { limit = { has_perk = time_mage_perk } add = 1 }
	if = { limit = { has_perk = glimpse_the_future_perk } add = 1 }
	if = { limit = { has_perk = financial_times_perk } add = 1 }
	if = { limit = { has_perk = celerity_perk } add = 1 }
	if = { limit = { has_perk = mass_celerity_perk } add = 1 }
	if = { limit = { has_perk = slowness_perk } add = 1 }
	if = { limit = { has_perk = mass_slowness_perk } add = 1 }
	if = { limit = { has_perk = temporal_manipulation_perk } add = 1 }
	if = { limit = { has_perk = master_of_time_perk } add = 1 }
	
	# Life tree
	if = { limit = { has_perk = life_mage_perk } add = 1 }
	if = { limit = { has_perk = inward_reflection_perk } add = 1 }
	if = { limit = { has_perk = inward_perfection_perk } add = 1 }
	if = { limit = { has_perk = heal_perk } add = 1 }
	if = { limit = { has_perk = greater_heal_perk } add = 1 }
	if = { limit = { has_perk = battlefield_life_mage_perk } add = 1 }
	if = { limit = { has_perk = greater_battlefield_life_mage_perk } add = 1 }
	if = { limit = { has_perk = purity_of_body_perk } add = 1 }
	if = { limit = { has_perk = avatar_of_life_perk } add = 1 }
	
	# Elemental tree
	if = { limit = { has_perk = elemental_mage_perk } add = 1 }
	if = { limit = { has_perk = flame_aura_perk } add = 1 }
	if = { limit = { has_perk = flaming_weapons_perk } add = 1 }
	if = { limit = { has_perk = living_earthworks_perk } add = 1 }
	if = { limit = { has_perk = golem_creation_perk } add = 1 }
	if = { limit = { has_perk = control_water_perk } add = 1 }
	if = { limit = { has_perk = drought_perk } add = 1 }
	if = { limit = { has_perk = elemental_warrior_perk } add = 1 }
	if = { limit = { has_perk = lord_of_the_elements_perk } add = 1 }
	
	# Death tree
	if = { limit = { has_perk = death_mage_perk } add = 1 }
	if = { limit = { has_perk = inflict_illness_perk } add = 1 }
	if = { limit = { has_perk = plague_lord_perk } add = 1 }
	if = { limit = { has_perk = aura_of_death_perk } add = 1 }
	if = { limit = { has_perk = necromancy_perk } add = 1 }
	if = { limit = { has_perk = drain_life_perk } add = 1 }
	if = { limit = { has_perk = death_stare_perk } add = 1 }
	if = { limit = { has_perk = death_magic_8_perk } add = 1 }
	if = { limit = { has_perk = deacon_of_death_perk } add = 1 }
	
	# Biomancy tree
	if = { limit = { has_perk = biomancy_mage_perk } add = 1 }
	if = { limit = { has_perk = improve_trait_perk } add = 1 }
	if = { limit = { has_perk = perfect_trait_perk } add = 1 }
	if = { limit = { has_perk = fertility_control_perk } add = 1 }
	if = { limit = { has_perk = impregnate_perk } add = 1 }
	if = { limit = { has_perk = weaken_trait_perk } add = 1 }
	if = { limit = { has_perk = criple_trait_perk } add = 1 }
	if = { limit = { has_perk = sculpter_of_flesh_perk } add = 1 }
	if = { limit = { has_perk = architect_of_bloodlines_perk } add = 1 }
	
	# Domination tree
	if = { limit = { has_perk = domination_mage_perk } add = 1 }
	if = { limit = { has_perk = entrance_perk } add = 1 }
	if = { limit = { has_perk = incite_lust_perk } add = 1 }
	if = { limit = { has_perk = incite_obedience_perk } add = 1 }
	if = { limit = { has_perk = dominate_perk } add = 1 }
	if = { limit = { has_perk = beguiling_aura_perk } add = 1 }
	if = { limit = { has_perk = friendship_perk } add = 1 }
	if = { limit = { has_perk = enchanting_aura_perk } add = 1 }
	if = { limit = { has_perk = master_of_puppets_perk } add = 1 }
}
