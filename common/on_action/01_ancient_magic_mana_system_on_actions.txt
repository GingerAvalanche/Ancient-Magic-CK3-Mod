yearly_global_pulse = {
	on_actions = {
		yearly_mana_pulse
	}
}

yearly_mana_pulse = {
	effect = {
		every_living_character = {
			limit = { is_magus_trigger = yes }
			set_variable = {
				name = mana_gen_months_left
				value = 12
			}
			trigger_event = { on_action = monthly_mana_gen }
			#set_variable = {
			#	name = mana_gen_days_left
			#	value = 365
			#}
			#trigger_event = { on_action = daily_mana_gen }
		}
	}
}

set_up_remaining_mana_gen_for_year = {
	effect = {
		set_variable = {
			name = mana_gen_months_left
			value = 12
			subtract = current_month
		}
		trigger_event = { on_action = monthly_mana_gen }
		#set_variable = {
		#	name = mana_gen_days_left
		#	value = 365
		#	subtract = current_day_in_year
		#}
		#trigger_event = { on_action = daily_mana_gen }
	}
}

monthly_mana_gen = {
	trigger = {
		has_variable = mana_gen_months_left
		var:mana_gen_months_left > 0
	}

	events = {
		AMS_mana_events.001 # Give 1 month of mana gen
	}

	on_actions = {
		delay = { days = days_total_in_month }
		monthly_mana_gen
	}

	effect = {
		change_variable = {
			name = mana_gen_months_left
			subtract = 1
		}
	}
}

daily_mana_gen = {
	trigger = {
		has_variable = mana_gen_days_left
		var:mana_gen_days_left > 0
	}

	events = {
		AMS_mana_events.004 # Give 1 day of mana gen
	}

	on_actions = {
		delay = { days = 1 }
		daily_mana_gen
	}

	effect = {
		change_variable = {
			name = mana_gen_days_left
			subtract = 1
		}
	}
}

# Fire this action to make updates to the player's mana and mana gen
# Some on_actions (specifically on_title_gained, among others) don't
# fire triggered events immediately, they register them to be fired
# on the next tick (day). If we reset max_mana to 0 and then clamp
# to max_mana immediately, it will always clamp to 0, because the
# reset doesn't take place immediately - it takes place the next day.
# Solution - delay the clamp to the next day as well.
on_reset_mana_system = {
	trigger = { is_magus_trigger = yes }

	effect = {
		set_variable = {
			name = max_mana
			value = 0
		}
		set_variable = {
			name = mana_gen
			value = 0
		}
		# Hook up to reset_mana_system's on_actions to register the things
		# your mod needs to do to update the player's mana and mana gen
		trigger_event = { on_action = reset_mana_system }
		trigger_event = { on_action = delayed_mana_clamp }
	}
}

reset_mana_system = {
	on_actions = { ancient_magic_reset_mana_system }
}

ancient_magic_reset_mana_system = {
	events = {
		ancient_magic_aura_update_events.001
	}

	effect = {
		change_variable = {
			name = mana_gen
			add = ancient_magic_mana_gen
		}
		change_variable = {
			name = max_mana
			add = ancient_magic_max_mana
		}
	}
}

delayed_mana_clamp = {
	effect = {
		set_variable = {
			name = mana
			value = {
				value = var:mana
				max = var:max_mana
				min = 0
			}
		}
	}
}
