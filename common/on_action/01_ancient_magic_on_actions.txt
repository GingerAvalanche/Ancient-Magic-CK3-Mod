reset_mana_system = {
	on_actions = { ancient_magic_reset_mana_system }
}

ancient_magic_reset_mana_system = {
	events = {
		ancient_magic_aura_update_events.001
	}

	effect = {
		change_variable = {
			name = mana_gen
			add = ancient_magic_mana_gen
		}
		change_variable = {
			name = max_mana
			add = ancient_magic_max_mana
		}
	}
}

grant_to_mage_action = {
	effect = {
		holder = {
			save_scope_as = old_holder
			faith = {
				save_scope_as = holder_faith
			}
			culture = {
				save_scope_as = holder_culture
			}
		}
		culture = {
			save_scope_as = land_culture
		}
		faith = {
			save_scope_as = land_faith
		}

		create_character = {
			save_scope_as = new_holder
			random_traits = yes
			age = { 18 65 }
			gender_female_chance = 50
			random_traits_list = {
				magic_potential_1 = { weight = { base = 50 } }
				magic_potential_2 = { weight = { base = 35 } }
				magic_potential_3 = { weight = { base = 15 } }
			}
			random_traits_list = {
				education_arcane_1 = { weight = { base = 35 } }
				education_arcane_2 = { weight = { base = 35 } }
				education_arcane_3 = { weight = { base = 20 } }
				education_arcane_4 = { weight = { base = 10 } }
			}
			random_traits_list = {
				count = { 1 2 }
				diplomat = {}
				family_first = {}
				august = {}
				reveler_1 = {}
				poet = {}
				architect = {}
				administrator = {}
				avaricious = {}
				scholar = {}
				theologian = {}
				whole_of_body = {}
				physician_1 = {}
				physician_2 = {}
				physician_3 = {}
				mystic_1 = {}
				mystic_2 = {}
				lifestyle_herbalist = {}
			}
			employer = scope:old_holder
			random_faith = {
				scope:land_faith = { trigger = { always = yes } }
				scope:holder_faith = { trigger = { always = yes } }
			}
			random_culture = {
				scope:land_culture = { trigger = { always = yes } }
				scope:holder_culture = { trigger = { always = yes } }
			}
		}

		create_title_and_vassal_change = {
			type = granted
			save_scope_as = title_change
			add_claim_on_loss = no
		}
		change_title_holder = {
			holder = scope:new_holder
			change = scope:title_change
		}
		resolve_title_and_vassal_change = scope:title_change

		scope:new_holder = {
			change_government = feudal_government
		}
	}
}

#Check immortals to see if they've been initialized
random_yearly_everyone_pulse = {
	on_actions = {
		check_lifetime_flags_for_immortal
	}
}

check_lifetime_flags_for_immortal = {
	trigger = {
		is_immortal = yes
		is_ai = no # Because they aren't real people :(
		NOT = { has_game_rule = none_immortal_lifetime_events_reset }
		immortal_has_lifetime_flags = yes
	}
	effect = {
		add_immortal_years_since_lifetime_reset = yes
		if = {
			limit = {
				has_game_rule = 1_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 1
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 10_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 10
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 25_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 25
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 50_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 50
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 75_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 75
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
		else_if = {
			limit = {
				has_game_rule = 100_immortal_lifetime_events_reset
				var:immortal_years_since_lifetime_reset >= 100
			}
			reset_immortal_years_since_lifetime_reset = yes
			immortal_remove_lifetime_flags = yes
		}
	}
}