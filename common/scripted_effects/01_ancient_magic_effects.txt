change_mana_drain_loc = {
	if = {
		limit = { $VALUE$ > 0 }
		custom_description = {
			text = negative_mana_drain
			value = $VALUE$
		}
	}
	else_if = {
		limit = { $VALUE$ < 0 }
		custom_description = {
			text = positive_mana_drain
			value = $VALUE$
		}
	}
}

change_ancestral_guardians_count = {
	if = {
		limit = {
			NOT = { exists = var:ancestral_guardians_count }
		}
		set_variable = {
			name = ancestral_guardians_count
			value = 0
		}
	}
	change_variable = { name = ancestral_guardians_count add = $VALUE$ }
}

immortal_remove_lifetime_flags = {
	if = { limit = { has_character_flag = has_refunded_perks } remove_character_flag = has_refunded_perks }
	if = { limit = { has_character_flag = declared_major_religious_war_flag } remove_character_flag = declared_major_religious_war_flag }
	if = { limit = { has_character_flag = has_created_a_faith } remove_character_flag = has_created_a_faith }
	if = { limit = { has_character_flag = converted_culture_this_lifetime } remove_character_flag = converted_culture_this_lifetime }
	if = { limit = { has_character_flag = used_lifetime_invasion } remove_character_flag = used_lifetime_invasion }
	if = { limit = { has_character_flag = used_lifetime_subjugation } remove_character_flag = used_lifetime_subjugation }
}

init_immortal_years_since_lifetime_reset = {
	if = {
		limit = {
			NOT = { exists = var:immortal_years_since_lifetime_reset }
		}
		set_variable = {
			name = immortal_years_since_lifetime_reset
			value = 0
		}
	}
}

reset_immortal_years_since_lifetime_reset = {
	set_variable = {
		name = immortal_years_since_lifetime_reset
		value = 0
	}
}

add_immortal_years_since_lifetime_reset = {
	init_immortal_years_since_lifetime_reset = yes
	change_variable = { name = immortal_years_since_lifetime_reset add = 1 }
}

increase_vanilla_trait_rank = {
	if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_bad_3
		}
		remove_trait = $TRAIT_PREFIX$_bad_3
		add_trait = $TRAIT_PREFIX$_bad_2
	}
	else_if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_bad_2
		}
		remove_trait = $TRAIT_PREFIX$_bad_2
		add_trait = $TRAIT_PREFIX$_bad_1
	}
	else_if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_bad_1
		}
		remove_trait = $TRAIT_PREFIX$_bad_1
	}
	else_if = {
		limit = {
			NOT = { has_trait = $TRAIT_PREFIX$_good }
			NOT = { has_trait = $TRAIT_PREFIX$_bad }
		}
		add_trait = $TRAIT_PREFIX$_good_1
	}
	else_if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_good_1
		}
		remove_trait = $TRAIT_PREFIX$_good_1
		add_trait = $TRAIT_PREFIX$_good_2
	}
	else_if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_good_2
		}
		remove_trait = $TRAIT_PREFIX$_good_2
		add_trait = $TRAIT_PREFIX$_good_3
	}
}

decrease_vanilla_trait_rank = {
	if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_good_3
		}
		remove_trait = $TRAIT_PREFIX$_good_3
		add_trait = $TRAIT_PREFIX$_good_2
	}
	else_if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_good_2
		}
		remove_trait = $TRAIT_PREFIX$_good_2
		add_trait = $TRAIT_PREFIX$_good_1
	}
	else_if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_good_1
		}
		remove_trait = $TRAIT_PREFIX$_good_1
	}
	else_if = {
		limit = {
			NOT = { has_trait = $TRAIT_PREFIX$_good }
			NOT = { has_trait = $TRAIT_PREFIX$_bad }
		}
		add_trait = $TRAIT_PREFIX$_bad_1
	}
	else_if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_bad_1
		}
		remove_trait = $TRAIT_PREFIX$_bad_1
		add_trait = $TRAIT_PREFIX$_bad_2
	}
	else_if = {
		limit = {
			has_trait = $TRAIT_PREFIX$_bad_2
		}
		remove_trait = $TRAIT_PREFIX$_bad_2
		add_trait = $TRAIT_PREFIX$_bad_3
	}
}

check_enough_mana = {
	if = {
		limit = {
			scope:am_spell_caster.var:mana < $SPELL_COST$
		}
		add_character_flag = casting_low_mana_spell
	}
}

check_enough_skill = {
	if = {
		limit = {
			NOT = { has_perk = $SPELL_PERK$ }
		}
		add_character_flag = casting_low_skill_spell
	}
}

am_remove_minor_illness = {
	remove_trait = smallpox
	remove_trait = sickly
	remove_trait = ill
	remove_trait = early_great_pox
	remove_trait = lovers_pox
	remove_trait = wounded_1
	remove_trait = infirm
}

am_remove_greater_illness = {
	remove_trait = pneumonic
	remove_trait = great_pox
	remove_trait = leper
	remove_trait = wounded_2
	remove_trait = maimed
	remove_trait = gout_ridden
	remove_trait = consumption
	remove_trait = cancer
	remove_trait = typhus
	remove_trait = bubonic_plague
}

am_remove_critical_illness = {
	remove_trait = wounded_3
	remove_trait = one_eyed
	remove_trait = one_legged
	remove_trait = disfigured
	remove_trait = scarred
	remove_trait = eunuch
	remove_trait = blind
	remove_trait = incapable
}

add_drained_modifier_scope_work_around = {
	add_character_modifier = {
		modifier = drained_modifier
		years = $YEARS$
	}
}