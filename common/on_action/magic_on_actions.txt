on_game_start = {
	on_actions = {
		set_up_spells
		set_up_tri_indices
	}
}

set_up_spells = {
	effect = {
		set_up_spells = yes
	}
}

set_up_tri_indices = {
	effect = {
		set_local_variable = { name = tmp value = 0 }
		every_province = {
			remove_variable = tri_num
			remove_variable = tri_sum
		}
		while = {
			count = 100
			random_province = {
				limit = { NOT = { has_variable = tri_num } }
				set_variable = { name = tri_num value = local_var:tmp }
				set_variable = {
					name = tri_sum
					value = var:tri_num.sum_n
				}
			}
			change_local_variable = {
				name = tmp
				add = 1
			}
		}
		remove_local_variable = tmp
	}
}


on_death = {
	on_actions = {
		reset_slowness_drain
		reset_mass_slowness_drain
		reset_master_of_time_drain
	}
}

reset_slowness_drain = {
	trigger = {
		has_character_modifier = slowness_modifier
	}

	effect = {
		every_living_character = {
			limit = {
				has_variable_list = slowness_spell_targets
				is_target_in_variable_list = { name = slowness_spell_targets target = prev }
			}
			remove_list_variable = { name = slowness_spell_targets target = scope:spell_target }
			trigger_event = { on_action = on_reset_mana_system }
		}
	}
}

reset_mass_slowness_drain = {
	trigger = {
		has_character_modifier = mass_slowness_modifier
	}

	effect = {
		every_living_character = {
			limit = {
				has_variable_list = mass_slowness_spell_targets
				is_target_in_variable_list = { name = mass_slowness_spell_targets target = prev }
			}
			remove_list_variable = { name = mass_slowness_spell_targets target = scope:spell_target }
			trigger_event = { on_action = on_reset_mana_system }
		}
	}
}

# immortals can still die from murder effects
reset_master_of_time_drain = {
	trigger = {
		has_trait = immortal
	}

	effect = {
		every_living_character = {
			limit = {
				has_variable_list = master_of_time_spell_targets
				is_target_in_variable_list = { name = master_of_time_spell_targets target = prev }
			}
			remove_list_variable = { name = master_of_time_spell_targets target = prev }
			trigger_event = { on_action = on_reset_mana_system }
		}
	}
}
